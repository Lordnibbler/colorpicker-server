#!/usr/bin/env ./node_modules/.bin/coffee

request = require 'request'
config  = require 'config'
moment  = require 'moment'
logger  = require '../src/logger'

# ugly munging to build fully qualified prod/dev API URL
domain = config.server.domain
if process.env['NODE_ENV'] != 'production'
  domain = "#{domain}:#{config.server.port}"
else
  domain = "#{process.env['USERNAME']}:#{process.env['PASSWORD']}@#{domain}"

off_url = "http://#{domain}/api/v1/scheduler/off"
on_url  = "http://#{domain}/api/v1/scheduler/on"

# request to turn off LEDs
turn_off = ->
  request off_url, (error, response, body) ->
    logger.info 'response: ', response.body
    if response.statusCode == 200
      logger.info 'turned LEDs off'
      process.exit

# request to turn on LEDs
turn_on = ->
  request on_url, (error, response, body) ->
    logger.info 'response: ', response.body
    if response.statusCode == 200
      logger.info 'turned LEDs on'
      process.exit

now = moment()
logger.info "now.hour(): #{now.hour()}"
turn_off() if now.hour() == 1  # 1am
turn_on()  if now.hour() == 18 # 6pm
